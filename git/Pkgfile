# Description: Directory content manager
# URL:         https://git-scm.com/
# Depends on:  curl expat libpcre2 perl

name=git
version=2.52.0
release=1
source="https://www.kernel.org/pub/software/scm/git/git-$version.tar.xz
	https://www.kernel.org/pub/software/scm/git/git-manpages-$version.tar.xz
	rc.gitd"

build() {
	sed -i "s|git_exec_path = libexec|& / 'git-core'|" \
		git-$version/meson.build

	_p5libdir=$(perl -MConfig -E 'say $Config{installsitelib}')

	meson setup build git-$version \
		--prefix=/usr \
		--libexecdir=lib \
		--buildtype=plain \
		--wrap-mode=nodownload \
		-D b_lto=true \
		-D b_pie=true \
		-D runtime_prefix=true \
		-D gettext=disabled \
		-D perllibdir=$_p5libdir \
		-D benchmarks=disabled \
		-D tests=false \
		-D fuzzers=false \

	ninja -C build -j ${JOBS:-1} -v
	DESTDIR=$PKG ninja -C build install

	# manual pages
	for d in man*; do
		mkdir -p $PKG/usr/share/man/$d
		install -m 0644 $d/* $PKG/usr/share/man/$d
	done

	# service
	install -m 0755 -D $SRC/rc.gitd $PKG/etc/rc.d/gitd

	# remove junk
	find $PKG \( -name perllocal.pod -o -name .packlist \) -delete
}
