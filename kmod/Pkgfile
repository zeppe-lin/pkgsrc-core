# Description: Kernel module utilities and library
# URL:         https://git.kernel.org/?p=utils/kernel/kmod/kmod.git
# Depends on:  openssl scdoc zstd

name=kmod
version=34.2
release=2
source="https://www.kernel.org/pub/linux/utils/kernel/kmod/kmod-$version.tar.xz
	config_paths.patch"

build() {
	# adjust configuration directory paths for depmod and modprobe
	patch -d kmod-$version -Np1 -i $SRC/config_paths.patch

	# -D manpages=true:        requires scdoc
	# -D fishcompletiondir=no: disable fish completion
	# -D zshcompletiondir=no:  disable zsh  completion
	meson setup build kmod-$version   \
		--prefix=/usr             \
		--bindir=/sbin            \
		--sbindir=/sbin           \
		--buildtype=plain         \
		--wrap-mode=nodownload    \
		-D b_lto=true             \
		-D b_pie=true             \
		-D fishcompletiondir=no   \
		-D zshcompletiondir=no    \
		-D build-tests=false      \
		-D manpages=true          \
		-D docs=false             \

	ninja -C build -j ${JOBS:-1} -v
	DESTDIR=$PKG ninja -C build install

	mkdir -p $PKG/lib
	mv $PKG/usr/lib/libkmod.so.* $PKG/lib
	ln -sf ../../lib/$(readlink $PKG/lib/libkmod.so.2) \
		$PKG/usr/lib/libkmod.so

	mkdir -p $PKG/bin
	ln -s ../sbin/kmod $PKG/bin/lsmod

	# remove junk dirs, use /etc/{depmod,modprobe}.d instead
	cd $PKG/usr/lib; rmdir depmod.d modprobe.d
}
