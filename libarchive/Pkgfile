# Description: Multi-format archive and compression library
# URL:         http://www.libarchive.org/
# Depends on:  acl bzip2 expat zstd

name=libarchive
version=3.8.4
release=1
source=https://github.com/$name/$name/releases/download/v$version/$name-$version.tar.xz

build() {
	# Enable multithreaded LZMA compression (used by bsdtar and others)
	export CFLAGS="$CFLAGS -DHAVE_LZMA_STREAM_ENCODER_MT=1"

	# ENABLE_LIBXML2=OFF: disable XML support (only needed for xar format)
	cmake -S $name-$version -B build -G Ninja \
		-D CMAKE_INSTALL_PREFIX=/usr \
		-D CMAKE_INSTALL_LIBDIR=lib \
		-D CMAKE_BUILD_TYPE=Release \
		-D CMAKE_C_FLAGS_RELEASE="$CFLAGS" \
		-D ENABLE_TAR_SHARED=ON \
		-D ENABLE_ICONV=OFF \
		-D ENABLE_LIBB2=OFF \
		-D ENABLE_LIBXML2=OFF \
		-D ENABLE_NETTLE=OFF \
		-D ENABLE_TEST=OFF \
		-D BUILD_TESTING=OFF \
		-D ENABLE_OPENSSL=OFF \
		-Wno-dev

	ninja -C build -j ${JOBS:-1} -v
	DESTDIR=$PKG ninja -C build install
}
