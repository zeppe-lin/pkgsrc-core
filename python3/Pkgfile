# Description: Python interpreter, version 3
# URL:         https://www.python.org/
# Depends on:  bzip2 expat gdbm libffi libnsl mpdecimal openssl sqlite3 xz

# 3.12.x LTS (EOL 2028-10)
# https://devguide.python.org/versions/

name=python3
version=3.12.7
release=2
source=https://github.com/python/cpython/archive/v$version/python-$version.tar.gz

build() {
	cd cpython-$version

	export PYTHON_DISABLE_MODULES="_tkinter _uuid"

	sed -e 's,-flto ,-flto=4 ,g'  \
	    -i configure configure.ac

	sed -e 's,^#.* /usr/local/bin/python,#!/usr/bin/python3,'  \
	    -i Lib/cgi.py

	sed -e "s,-j0,-j$(nproc)," \
	    -i Makefile.pre.in

	./configure \
		--prefix=/usr                        \
		--enable-shared                      \
		--enable-optimizations               \
		--enable-ipv6                        \
		--enable-loadable-sqlite-extensions  \
		--with-dbmliborder=gdbm:ndbm         \
		--with-system-expat                  \
		--with-system-libmpdec               \
		--with-tzpath=/usr/share/zoneinfo    \
		--with-ensurepip=yes                 \

	make EXTRA_CFLAGS="$CFLAGS" V=1
	make -j1 EXTRA_CFLAGS="$CFLAGS" DESTDIR=$PKG altinstall maninstall

	ln -s 2to3-${version%.*}            $PKG/usr/bin/2to3
	ln -s python${version%.*}           $PKG/usr/bin/python3
	ln -s python${version%.*}-config    $PKG/usr/bin/python3-config
	ln -s idle${version%.*}             $PKG/usr/bin/idle3
	ln -s pydoc${version%.*}            $PKG/usr/bin/pydoc3
	ln -s python${version%.*}           $PKG/usr/lib/$name
	ln -s python-${version%.*}.pc       $PKG/usr/lib/pkgconfig/python3.pc
	ln -s python-${version%.*}-embed.pc $PKG/usr/lib/pkgconfig/python3-embed.pc

	# https://bugs.archlinux.org/task/46146
	mkdir -p $PKG/usr/lib/python${version%.*}/Tools/i18n \
	         $PKG/usr/lib/python${version%.*}/Tools/scripts
	install -m 0755 -D Tools/i18n/msgfmt.py Tools/i18n/pygettext.py \
		$PKG/usr/lib/python${version%.*}/Tools/i18n/
	install -m 0755 -D Tools/scripts/*.py \
		$PKG/usr/lib/python${version%.*}/Tools/scripts/

	# Zeppe-Lin considers pip3 to be a part of Python 3, so remove annoying
	# update messages.
	mkdir -p $PKG/etc
	cat >$PKG/etc/pip.conf <<EOF
[global]
root-user-action = ignore
disable-pip-version-check = true
EOF

	# remove junk
	rm $PKG/usr/lib/python${version%.*}/ctypes/macholib/README.ctypes
	rm $PKG/usr/lib/python${version%.*}/idlelib/ChangeLog
	rm $PKG/usr/lib/python${version%.*}/idlelib/NEWS2x.txt
	rm $PKG/usr/lib/python${version%.*}/idlelib/README.txt
	rm $PKG/usr/lib/python${version%.*}/idlelib/TODO.txt
	rm $PKG/usr/lib/python${version%.*}/idlelib/CREDITS.txt
	rm $PKG/usr/lib/python${version%.*}/idlelib/HISTORY.txt
	rm $PKG/usr/lib/python${version%.*}/idlelib/Icons/README.txt
	rm $PKG/usr/lib/python${version%.*}/site-packages/README.txt
	rm $PKG/usr/lib/python${version%.*}/idlelib/idle_test/README.txt
	rm $PKG/usr/lib/python${version%.*}/test/crashers/README
	rm $PKG/usr/lib/python${version%.*}/test/data/README
	rm $PKG/usr/lib/python${version%.*}/test/leakers/README.txt
	rm $PKG/usr/lib/python${version%.*}/test/sndhdrdata/README
	rm $PKG/usr/lib/python${version%.*}/test/test_lib2to3/data/README
	rm $PKG/usr/lib/python${version%.*}/test/test_tkinter/README
	rm $PKG/usr/lib/python${version%.*}/test/xmltestdata/c14n-20/README
	rm $PKG/usr/lib/python${version%.*}/test/ziptestdata/README.md

	# remove "optional" solibs
	rm -f $PKG/usr/lib/python*/lib-dynload/_tkinter.*.so
	rm -f $PKG/usr/lib/python*/lib-dynload/_uuid.*.so
}
