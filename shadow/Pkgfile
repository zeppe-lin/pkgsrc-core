# Description: Shadow password file utilities
# URL:         https://github.com/shadow-maint/shadow/
# Depends on:  acl libbsd linux-pam

name=shadow
version=4.16.0
release=1
source="https://github.com/shadow-maint/$name/releases/download/$version/$name-$version.tar.xz
	cron.pwck
	pam.chfn pam.chsh pam.groupadd pam.groupdel pam.groupmems
	pam.groupmod pam.login pam.passwd pam.su pam.useradd
	pam.userdel pam.usermod"

build() {
	mkdir build; cd build

	../$name-$version/configure  \
		--prefix=/usr        \
		--bindir=/usr/bin    \
		--sbindir=/usr/sbin  \
		--sysconfdir=/etc    \
		--disable-logind     \
		--disable-nls        \
		--disable-shadowgrp  \
		--disable-shared     \
		--enable-lastlog     \
		--without-audit      \
		--without-btrfs      \
		--without-selinux    \

	make V=1
	make DESTDIR=$PKG install
	make -C man DESTDIR=$PKG install

	mkdir -p $PKG/bin $PKG/sbin $PKG/etc/cron/daily $PKG/var/log

	mv $PKG/usr/bin/login    $PKG/bin/
	mv $PKG/usr/sbin/nologin $PKG/sbin/

	chmod -s $PKG/usr/sbin/*

	# login.defs
	install -m 0644 -D ../$name-$version/etc/login.defs $PKG/etc/

	# cron
	install -m 0755 -D $SRC/cron.pwck $PKG/etc/cron/daily/pwck

	touch $PKG/var/log/lastlog
	touch $PKG/var/log/faillog

	# pam configs
	for f in pam.chfn pam.chsh pam.groupadd pam.groupdel     \
		pam.groupmems pam.groupmod pam.login pam.passwd  \
		pam.su pam.useradd pam.userdel pam.usermod
	do
		install -o root -g root -m 0644 \
			$SRC/$f $PKG/etc/pam.d/${f#pam.}
	done

	# remove junk and unused stuff
	rm -r $PKG/usr/bin/gpasswd                \
	      $PKG/usr/share/man/man1/gpasswd.1   \
	      $PKG/usr/sbin/chpasswd              \
	      $PKG/usr/share/man/man8/chpasswd.8  \
	      $PKG/usr/sbin/grpconv               \
	      $PKG/usr/share/man/man8/grpconv.8   \
	      $PKG/usr/sbin/grpunconv             \
	      $PKG/usr/share/man/man8/grpunconv.8 \
	      $PKG/usr/sbin/logoutd               \
	      $PKG/usr/share/man/man8/logoutd.8   \
	      $PKG/usr/sbin/newusers              \
	      $PKG/usr/share/man/man8/newusers.8  \
	      $PKG/usr/sbin/pwconv                \
	      $PKG/usr/share/man/man8/pwconv.8    \
	      $PKG/usr/sbin/pwunconv              \
	      $PKG/usr/share/man/man8/pwunconv.8  \
	      $PKG/usr/share/man/man5/gshadow.5   \
	      $PKG/usr/share/man/man3
}
